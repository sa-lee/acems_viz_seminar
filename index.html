<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Visualising in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Ursula Laa and Stuart Lee" />
    <link href="libs/remark-css/kunoichi.css" rel="stylesheet" />
    <link href="libs/remark-css/ninjutsu.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">

layout: false
class: split-33 with-thick-border border-black

&lt;style type="text/css"&gt;
/* custom.css */
:root{
  --main-color1: #2f4c7a;
  --main-color2: #bcbddc;
  --main-color3: #efedf5;
  --main-color4: #9DDAE5;
  --text-color3: black;
  --text-color4: black;
  --code-inline-color: #4e5054;
  --link-color: #006CAB;
  --logo: url(http://www.fragiletoagile.com.au/wp-content/uploads/2018/02/monash-university-logo-transparent.png);
}
.huge { font-size: 300% }
.large { font-size: 150% }
.largeish { font-size: 120% }
.summarystyle { font-size: 150%;
  line-height:150%;}

.left-code {
  color: #777;
  width: 48%;
  height: 92%;
  float: left;
}
.right-plot {
  width: 50%;
  float: right;
  padding-left: 1%;
}
&lt;/style&gt;







.column[.bottom_abs.content[
&lt;img src="http://www.fragiletoagile.com.au/wp-content/uploads/2018/02/monash-university-logo-transparent.png" width="70%"&gt;
]]

.column.bg-main1[.content.vmiddle[.center[


# Visualising in R


### ggplot2 !
&lt;br&gt;
&lt;br&gt;

# Ursula Laa
# and
# Stuart Lee


### School of Physics and Astronomy
### &amp;
### Department of Econometrics and Business Statistics

]]]

---

# A grammar of graphics

.largeish[
The grammar of graphics is a framework for constructing statistical graphics in a principled way. 
The grammar defines an explicit relationship between the variables in your data you have and the graphic or plot you wish to represent. It was first defined by Lee Wilkinson and extended by Hadley Wickham in the R package `ggplot2`. 

Here we uncover how the charts you know by name can be created via `ggplot2`, learn how to construct a `ggplot2` graphic and then build a plot up, layer-by-layer.
]

&lt;br&gt;

## Why use the grammar of graphics?

.largeish[
The grammar of graphics allows you to __define__ the mapping between variables in the data, with elements of the plot. It allows us to see and understand __how__ plots are similar or different. 

The grammar also helps you see how variations in the definition create variations in the plot. Using named plots, for example a pie chart, bar chart, scatterplot, in some ways is like seeing animals in the zoo. 
]
---

# Example data

### World Health Organisation (WHO) tuberculosis case notifications data 

.large[To showcase `ggplot2` we will build graphics using a data set provided by the [World Health Organisation (WHO)](https://www.who.int/). This is current tuberculosis (TB) case notifications aggregated by __country__, __gender__ and __age__ group. We have tidied up this data for you and saved it in the R data storage format.]

XXX how to share data? update download?
Before making your way through this step, we strongly recommend that you [download the data set](https://github.com/datascienceprogram/ids_course_data/blob/master/data/tb_tidy.rds) and then place it in your project folder on your computer.

.largeish[
The data consists of six columns:

* __country:__ the country where the TB case(s) occured
* __iso3:__ a three letter standardised country code
* __year:__ the year when the TB case(s) occured
* __gender:__ whether the TB case(s) belonged to males or females.
* __age_group:__ whether the TB case(s) belonged to someone aged between 15 to 24, 25 to 34,
35 to 44, 45 to 54, 55 to 64 or 65 and above
* __count:__ the total number of TB cases for a given country, year, gender and age group.
]
---
layout: false
class: split-40 with-thick-border border-white

.column[.content[

# Load the data in RStudio on your computer

.large[On your computer, open RStudio and then load the TB data in with R using the tidyverse:]


```r
library(tidyverse)
tb &lt;- read_rds("data/tb_tidy.rds")
tb
```

&lt;br&gt;

.large[We will use a subset of this data corresponding to TB cases in Australia]


```r
tb_au &lt;- filter(
  tb, country == "Australia"
  )
tb_au
```

]]

--

.column[.content.vmiddle[


```
## # A tibble: 47,866 x 6
##    country     iso3   year count gender age_group
##    &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;  &lt;fct&gt;    
##  1 Afghanistan AFG    1997    10 M      15-24    
##  2 Afghanistan AFG    1998   129 M      15-24    
##  3 Afghanistan AFG    1999    55 M      15-24    
##  4 Afghanistan AFG    2000   228 M      15-24    
##  5 Afghanistan AFG    2001   379 M      15-24    
##  6 Afghanistan AFG    2002   476 M      15-24    
##  7 Afghanistan AFG    2003   511 M      15-24    
##  8 Afghanistan AFG    2004   537 M      15-24    
##  9 Afghanistan AFG    2005   606 M      15-24    
## 10 Afghanistan AFG    2006   837 M      15-24    
## # â€¦ with 47,856 more rows
```
]]
---

# A first look

.largeish[Let's create charts from the TB data to find out if there are differences between age groups, and gender between TB cases in Australia.

We start with a 100% chart, that compares the proportion of TB cases in each age group by gender.]

&lt;br&gt;

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-3-1.png" style="display: block; margin: auto;" /&gt;

---

# A first look

.largeish[Let's create charts from the TB data to find out if there are differences between age groups, and gender between TB cases in Australia.

We start with a 100% chart, that compares the proportion of TB cases in each age group by gender.]

&lt;br&gt;

## What can you learn from a 100% chart? 

.largeish[
There are three key lessons from this chart:

 * The focus is on **proportion** in each category. 
 * Across (almost) all ages, and years, the proportion of males having TB is higher than females
 * These proportions tend to be higher in the older age groups, for all years.
]

---

class: middle center bg-main1

# Building your own ggplot

---

# Building your own ggplot

.largeish[We start building a ggplot2 graphic with the function `ggplot()`, passing a *data set* and an *aesthetic mapping* as arguments to the function. 
The *aesthetic mapping* (or *variable mapping*) is constructed with the function `aes()`, telling `ggplot()` which variable in our data should correspond to a particular graphical element to be drawn.]

### Example


```r
p &lt;- ggplot(tb_au, aes(x = year, y = count, fill = gender))
```

.large[The first argument provided is the name of the data, `tb_au`. And the variable mapping consists of three elements, the variable:]

.largeish[
- __year__ will be mapped to the x-axis, 
- __count__ will be mapped to the y-axis  
- __gender__ will be mapped to the fill element (it will be the colour)
]

.largeish[This generates a blank plot, we still need to tell ggplot what geometric shape to draw!]

---

layout: false
class: split-33

.column[.content[
## Stepwise building of a `ggplot2`


```r
*ggplot(tb_au)
```
]]

.column[.content.vmiddle[
&lt;img src="/Users/lee.s/acems_viz_seminar/figures/output1-1.png" style="display: block; margin: auto;" /&gt;
]]

---

layout: false
class: split-33

.column[.content[
## Stepwise building of a `ggplot2`


```r
ggplot(tb_au) +
* aes(x = year,
*     y = count,
*     fill = gender)
```
]]

.column[.content.vmiddle[
&lt;img src="/Users/lee.s/acems_viz_seminar/figures/output2-1.png" style="display: block; margin: auto;" /&gt;
]]

---

layout: false
class: split-33

.column[.content[
## Stepwise building of a `ggplot2`


```r
ggplot(tb_au) +
  aes(x = year, 
      y = count, 
      fill = gender) +
* geom_bar(stat = "identity",
*          position = "fill")
```

.largeish[
- `stat = "identity"` says no need to compute the count (it is already counted in the data)
- `position = "fill"` specifies how the bars are placed, it sets the heights of the bars to be all at 100%, and emphasizes the proportion of males and females
]
]]

.column[.content.vmiddle[
&lt;img src="/Users/lee.s/acems_viz_seminar/figures/output3-1.png" style="display: block; margin: auto;" /&gt;
]]

---

layout: false
class: split-33

.column[.content[
## Stepwise building of a `ggplot2`


```r
ggplot(tb_au) +
  aes(x = year, 
      y = count, 
      fill = gender) +
  geom_bar(stat = "identity", 
           position = "fill") +
* scale_fill_brewer(
*   palette = "Dark2")
```

.largeish[
`ggplot` automatically draws a legend, but you may want might want to change the colour of the bars to accommodate colour blindness. This can be done with a `scale` element, and here we use a palette from [colorbrewer.org](colorbrewer.org).
]
]]

.column[.content.vmiddle[
&lt;img src="/Users/lee.s/acems_viz_seminar/figures/output4-1.png" style="display: block; margin: auto;" /&gt;
]]

---

layout: false
class: split-33

.column[.content[
## Stepwise building of a `ggplot2`


```r
ggplot(tb_au) +
  aes(x = year, 
      y = count, 
      fill = gender) +
  geom_bar(stat = "identity", 
           position = "fill") +
  scale_fill_brewer(  
    palette = "Dark2") +
* facet_grid(. ~ age_group)
```

.largeish[
Finally we create a bar chart for each age group present in the TB notifactions, which you can do by adding a `facet` element. A `facet` creates subplots for each category (or combination of categories) laid out in a grid. The argument is specified as a *formula*, and is of the form left hand side ~ right hand side
]
]]

.column[.content.vmiddle[
&lt;img src="/Users/lee.s/acems_viz_seminar/figures/output5-1.png" style="display: block; margin: auto;" /&gt;
]]

---

To summarise, you have created your first `ggplot` one layer at a time. Once you become more confident you will be able to start building everything up at once. Your completed chart should resemble the following:


```r
p &lt;- ggplot(tb_au, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~ age_group) +
  scale_fill_brewer(palette="Dark2")
p
```

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-5-1.png" style="display: block; margin: auto;" /&gt;

---

# Counts vs proportions


&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;


## What we learn from this chart? 

.largeish[
- Focus on **counts**, it shows that counts are different across __ages__, and __years__: counts tend to be lower in middle age (45-64). 
- Shows that in the year 1999, there was a bit of a TB outbreak in most age groups, with numbers doubling or tripling compared to other years. The TB Incidence has been increasing among younger age groups in recent years.
]

---

## Give it a go!

You can make this bar chart using `ggplot2` by changing the position argument
in `geom_bar()` to `stack`, with the following code chunk: 


```r
p &lt;- ggplot(tb_au, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(~ age_group) +
  scale_fill_brewer(palette="Dark2")
p
```

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-7-1.png" style="display: block; margin: auto;" /&gt;

---

# From 'stacked' to 'side-by-side'

.large[Let's change the position argument in `geom_bar()` to `dodge` to show the counts in each age category but with respect to __gender__]


```r
ggplot(tb_au, aes(x = year, y = count, fill = gender)) +
  geom_bar(stat = "identity", position="dodge") +
  facet_grid(~ age_group) +
  scale_fill_brewer(palette="Dark2")
```

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-8-1.png" style="display: block; margin: auto;" /&gt;

---

# What can you learn from this chart? 

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-9-1.png" style="display: block; margin: auto;" /&gt;

.largeish[
- Focus on counts by gender, showing predominantly male incidence of TB.
- You can also see that incidence among males relative to females is from middle age onwards. There appears to be
similar incidence between males and females in younger age groups.
]

.largeish[What's changed from your previous charts? The colours, aesthetics and facets have remained the same, it's just the __position__ of the bars that have been altered ]

---

# Beyond bar charts

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/unnamed-chunk-10-1.png" style="display: block; margin: auto;" /&gt;

.large[This rainbow chart is visually appealling, but it's difficult to interpret. In what way could use `ggplot2` to make the chart easier to interpet?]

---
layout: false
class: split-33

.column[.content[
# Changing coordinates



```r
ggplot(
  tb_au,
  aes(x = year,
      y = count,
      fill = gender)
  ) +
  geom_bar(
    stat = "identity"
    ) +
  facet_grid(
    gender ~ age_group
    ) +
  scale_fill_brewer(
    palette="Dark2"
    ) + 
  coord_polar() 
```
]]

.column[.content[
.largeish[
By changing the cartesian coordinates to __polar__, things will be layed out in __circles__, rather than __rectangles__. 
When using polar coordinates, one axis is mapped to an __angle__, rather than a position.
]
&lt;img src="/Users/lee.s/acems_viz_seminar/figures/outputPolar-1.png" style="display: block; margin: auto;" /&gt;
.large[This layout makes it easier to interpret how the chart emphasises the middle age groups as having low incidence accross the years.]

]]




---
layout: false
class: split-33

.column[.content[
# Transform from rainbox to pie

You can continue to use polar coordinates to modify your rainbow chart and transform it to a pie chart. 



```r
ggplot(tb_au,
       aes(
         x = 1,
         y = count,
         fill = factor(year)
         )
       ) +
  geom_bar(
    stat = "identity", position="fill"
    ) +
  facet_grid(
    gender ~ age_group
    ) +
  coord_polar(
    theta = "y"
    )
```
]]

.column[.content[

&lt;br&gt;

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/outputPie-1.png" style="display: block; margin: auto;" /&gt;

.large[By doing this, you get another pretty chart that's difficult to interpret and unuseful for making comparisons across age groups.]

]]


---

layout: false
class: split-50 with-thick-border border-white



.column[.content[

## Re-arrangement and proximity


```r
tb_au %&gt;% filter(year == 2012) %&gt;%
  ggplot() +
  aes(x=gender, y=count, fill=gender) +
  geom_bar(stat="identity", position="dodge") + 
  facet_wrap(~age_group, ncol=6) +
  scale_fill_brewer("", palette="Dark2") +
  ggtitle("Arrangement A")
```

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/arrA-1.png" style="display: block; margin: auto;" /&gt;
]]

.column[.content[

&lt;br&gt;
&lt;br&gt;


```r
tb_au %&gt;% filter(year == 2012) %&gt;%
  ggplot() +
  aes(x=age_group, y=count, fill=age_group) +
  geom_bar(stat="identity", position="dodge") + 
  facet_wrap(~gender, ncol=6) +
  scale_fill_brewer("", palette="Dark2") +
  ggtitle("Arrangement B")
```

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/arrB-1.png" style="display: block; margin: auto;" /&gt;
]]


---

# Re-arrangement and proximity

.large[
- Arrangement A makes it easier to directly compare male and female counts, separately for each age group. Generally, male counts are higher than female counts. There is a big difference between counts in the 45-54 age group, and over 65 counts are almost the same.
- Arrangement B makes it easier to directly compare counts by age group, separately for females and males. For females, incidence drops in the middle years. For males, it is pretty consistently high across age groups. 
]

&lt;img src="/Users/lee.s/acems_viz_seminar/figures/both-1.png" style="display: block; margin: auto;" /&gt;
---

### Grammar and Statistics


What I love about ggplot2...

&lt;img src="https://www.wired.com/wp-content/uploads/2016/01/DB-Transformation-Colour.gif" style="width: 40%" /&gt;

[Source: https://www.wired.com/wp-content/uploads/2016/01/DB-Transformation-Colour.gif](https://www.wired.com/wp-content/uploads/2016/01/DB-Transformation-Colour.gif)

...you can make so many different displays of the same data, and each time something new may emerge. 

---

### Discussion

- Grammar of graphics makes rearranging easy
- Its good to look at the data in many different ways [Unwin, Hofmann and Cook](https://journal.r-project.org/archive/2013/RJ-2013-012/RJ-2013-012.pdf)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="libs/jquery/jquery.min.js"></script>
<script src="libs/slides.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"ratio": "16:9",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
